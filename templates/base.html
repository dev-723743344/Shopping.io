<!DOCTYPE html>
<html lang="uz" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Shop.io{% endblock %}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Updated to use Inter font only for better performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Geist+Mono:wght@100..900&family=Geist:wght@100..900&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            background: '#ffffff',
            foreground: '#000000',
            muted: '#f5f5f5',
            'muted-foreground': '#666666',
            border: '#e5e5e5',
            accent: '#000000',
            'accent-foreground': '#ffffff',
            neutral: {
              50: "#fafafa",
              100: "#f5f5f5",
              200: "#e5e5e5",
              300: "#d4d4d4",
              400: "#a3a3a3",
              500: "#737373",
              600: "#525252",
              700: "#404040",
              800: "#262626",
              900: "#171717",
              950: "#000000"
            }
          },
          fontFamily: {
            'sans': ['Geist', 'sans-serif']
          }
        }
      }
    }
  </script>

  <style>
    :root {
      font-family: "Geist", sans-serif;
    }

    /* Optimized sidebar transition with better performance */
    .sidebar-transition {
      transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .sidebar-hidden {
      transform: translateX(-100%);
    }

    /* Enhanced tooltip styling */
    .tooltip {
      position: absolute;
      left: 100%;
      top: 50%;
      transform: translateY(-50%);
      margin-left: 0.75rem;
      padding: 0.5rem 0.75rem;
      background: #000000;
      color: #ffffff;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s ease;
      z-index: 50;
    }

    .dark .tooltip {
      background: #ffffff;
      color: #000000;
    }

    /* Improved page transition with better performance */
    .page-content {
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.2s ease forwards;
    }

    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Optimized loading overlay with faster transitions */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
    }

    .loading-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .dark .loading-overlay {
      background: rgba(0, 0, 0, 0.95);
    }

    /* Optimized spinner with better performance */
    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid #e5e5e5;
      border-top: 2px solid #000000;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    .dark .spinner {
      border-color: #333333;
      border-top-color: #ffffff;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Updated dark mode colors to match Vercel/v0.dev style - pure black backgrounds with proper contrast */
    .dark {
      --tw-bg-background: #000000;
      --tw-text-foreground: #ffffff;
      --tw-bg-muted: #0a0a0a;
      --tw-text-muted-foreground: #888888;
      --tw-border-border: #1a1a1a;
      --tw-bg-accent: #ffffff;
      --tw-text-accent-foreground: #000000;
    }

    /* Dark mode overrides for consistent Vercel-style appearance */
    .dark body {
      background-color: #000000 !important;
      color: #ffffff !important;
    }

    .dark .bg-background {
      background-color: #000000 !important;
    }

    .dark .text-foreground {
      color: #ffffff !important;
    }

    .dark .bg-muted {
      background-color: #0a0a0a !important;
    }

    .dark .text-muted-foreground {
      color: #888888 !important;
    }

    .dark .border-border {
      border-color: #1a1a1a !important;
    }

    .dark .bg-accent {
      background-color: #ffffff !important;
    }

    .dark .text-accent-foreground {
      color: #000000 !important;
    }

    /* Additional dark mode card and surface colors */
    .dark .bg-muted\/30 {
      background-color: #050505 !important;
    }

    .dark .shadow-sm {
      box-shadow: 0 1px 2px 0 rgba(255, 255, 255, 0.05) !important;
    }

    .dark .shadow-lg {
      box-shadow: 0 10px 15px -3px rgba(255, 255, 255, 0.1), 0 4px 6px -2px rgba(255, 255, 255, 0.05) !important;
    }

    /* Dark mode navigation and sidebar */
    .dark nav {
      background-color: rgba(0, 0, 0, 0.95) !important;
      backdrop-filter: blur(8px);
    }

    .dark aside {
      background-color: #000000 !important;
    }

    /* Dark mode hover states */
    .dark .hover\:bg-muted:hover {
      background-color: #0a0a0a !important;
    }

    .dark .hover\:text-foreground:hover {
      color: #ffffff !important;
    }

    /* Completely rewritten main content layout system */
    .layout-container {
      display: flex;
      height: calc(100vh - 64px);
      position: relative;
    }

    .sidebar-wrapper {
      flex-shrink: 0;
      width: 256px;
      transition: width 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .sidebar-wrapper.hidden {
      width: 0;
    }

    .main-content-wrapper {
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }

    .main-content {
      height: 100%;
      overflow-y: auto;
    }

    /* Mobile responsive layout */
    @media (max-width: 767px) {
      .sidebar-wrapper {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        z-index: 20;
        width: 256px !important;
      }

      .sidebar-wrapper.hidden {
        width: 256px !important;
      }

      .main-content-wrapper {
        width: 100%;
      }
    }

    /* Exam mode styles for timer in navbar and text selection */
    .exam-mode .navbar-timer {
      display: flex !important;
      align-items: center;
      justify-content: center;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      background: #000000;
      color: #ffffff;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 600;
      z-index: 40;
    }

    .dark .exam-mode .navbar-timer {
      background: #ffffff;
      color: #000000;
    }

    /* Text selection highlighting for reading passages */
    .passage-content ::selection {
      background-color: #fbbf24;
      color: #000000;
    }

    .dark .passage-content ::selection {
      background-color: #f59e0b;
      color: #ffffff;
    }

    /* Exam warning modal styles */
    .exam-warning-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .exam-warning-modal.show {
      opacity: 1;
      visibility: visible;
    }

    .exam-warning-content {
      background: #ffffff;
      border-radius: 12px;
      padding: 2rem;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .dark .exam-warning-content {
      background: #000000;
      border: 1px solid #1a1a1a;
    }

    /* Added mobile overlay for sidebar */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 19;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .sidebar-overlay.show {
      opacity: 1;
      visibility: visible;
    }
  </style>
</head>

<body class="bg-background text-foreground h-full antialiased">
  <!-- Improved loading overlay with better spinner -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="flex flex-col items-center space-y-3">
      <div class="spinner"></div>
      <p class="text-sm text-muted-foreground">Yuklanmoqda...</p>
    </div>
  </div>

  <!-- Added exam warning modal -->
  <div id="examWarningModal" class="exam-warning-modal">
    <div class="exam-warning-content">
      <div class="mb-4">
        <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
        <h3 class="text-lg font-semibold text-foreground mb-2">Testni yakunlaysizmi?</h3>
        <p class="text-sm text-muted-foreground">Agar sahifani tark etsangiz, test avtomatik yakunlanadi va natijangiz
          saqlanadi.</p>
      </div>
      <div class="flex space-x-3 justify-center">
        <button id="examWarningCancel"
          class="px-4 py-2 text-sm font-medium text-muted-foreground hover:text-foreground border border-border rounded-lg hover:bg-muted transition-colors">
          Bekor qilish
        </button>
        <button id="examWarningConfirm"
          class="px-4 py-2 text-sm font-medium bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
          Ha, yakunlash
        </button>
      </div>
    </div>
  </div>

  <!-- Added mobile sidebar overlay -->
  <div id="sidebarOverlay" class="sidebar-overlay md:hidden"></div>

  <!-- Updated navigation with cleaner styling and better contrast -->
  <nav
    class="fixed top-0 inset-x-0 h-16 bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60 border-b border-border z-30 flex items-center justify-between px-4 sm:px-6">
    <div class="flex items-center space-x-3">
      <button id="sidebarToggle"
        class="inline-flex items-center justify-center h-9 w-9 rounded-lg text-muted-foreground hover:bg-muted hover:text-foreground transition-colors focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
        <i class="fas fa-bars text-sm"></i>
      </button>
      <a href="{% url 'dashboard' %}" class="font-sans font-semibold text-xl tracking-tight text-foreground">Shop.io</a>
    </div>

    <div class="flex items-center space-x-2 sm:space-x-4">
      <button id="themeToggle"
        class="inline-flex items-center justify-center h-9 w-9 rounded-lg text-muted-foreground hover:bg-muted hover:text-foreground transition-colors focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
        <i class="fas fa-moon hidden dark:block text-sm"></i>
        <i class="fas fa-sun block dark:hidden text-sm"></i>
      </button>

      {% if user.is_authenticated %}
      <div class="relative">
        <button id="userBtn"
          class="flex items-center space-x-2 p-1.5 rounded-lg hover:bg-muted transition-colors focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2">
          <div
            class="h-8 w-8 rounded-full bg-muted text-muted-foreground flex items-center justify-center text-sm font-medium border border-border">
            {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
          </div>
        </button>

        <div id="userMenu"
          class="hidden absolute right-0 mt-2 w-48 bg-background border border-border rounded-lg shadow-lg py-1 z-50">
          <div class="px-4 py-3 border-b border-border">
            <p class="text-sm font-medium text-foreground">{{ user.get_full_name }}</p>
            <p class="text-xs text-muted-foreground">{{ user.email }}</p>
          </div>
          <a href="#" class="block px-4 py-2 text-sm text-foreground hover:bg-muted transition-colors">Profil</a>
          <a href="{% url 'logout' %}"
            class="block px-4 py-2 text-sm text-foreground hover:bg-muted transition-colors">Chiqish</a>
        </div>
      </div>
      {% endif %}
    </div>
  </nav>

  <div class="flex pt-16 h-full">
    <!-- Wrapped layout in flex container for proper sidebar behavior -->
    <div class="layout-container w-full">
      {% if user.is_authenticated %}
      <!-- Updated sidebar wrapper structure -->
      <div id="sidebarWrapper" class="sidebar-wrapper hidden">
        <aside id="sidebar" class="sidebar-transition bg-background border-r border-border w-full h-full sidebar-hidden"
          data-collapsed="false">
          <nav class="flex-1 p-4 space-y-2">
            {% with request.resolver_match.url_name as url_name %}
            <a href="{% url 'dashboard' %}"
              class="group relative flex items-center px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 {% if url_name == 'dashboard' %}bg-muted text-foreground{% else %}text-muted-foreground hover:bg-muted hover:text-foreground{% endif %}">
              <i class="fas fa-home w-5 text-center"></i>
              <span class="sidebar-label ml-3">Bosh sahifa</span>
              <span class="tooltip">Bosh sahifa</span>
            </a>
            <a href="{% url 'clientlist' %}"
              class="group relative flex items-center px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 {% if url_name == 'clientlist' %}bg-muted text-foreground{% else %}text-muted-foreground hover:bg-muted hover:text-foreground{% endif %}">
              <i class="fas fa-users w-5 text-center"></i>
              <span class="sidebar-label ml-3">Mijozlar</span>
              <span class="tooltip">Mijozlar</span>
            </a>

            <a href="{% url 'productlist' %}"
              class="group relative flex items-center px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 {% if url_name == 'productlist' %}bg-muted text-foreground{% else %}text-muted-foreground hover:bg-muted hover:text-foreground{% endif %}">
              <i class="fas fa-boxes w-5 text-center"></i>
              <span class="sidebar-label ml-3">Mahsulotlar</span>
              <span class="tooltip">Mahsulotlar</span>
            </a>

            <a href="{% url 'sale_list' %}"
              class="group relative flex items-center px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 {% if url_name == 'sale_list' %}bg-muted text-foreground{% else %}text-muted-foreground hover:bg-muted hover:text-foreground{% endif %}">
              <i class="fas fa-shopping-cart w-5 text-center"></i>
              <span class="sidebar-label ml-3">Sotuv</span>
              <span class="tooltip">Sotuv</span>
            </a>

            <a href="{% url 'statistics' %}"
              class="group relative flex items-center px-3 py-2.5 rounded-lg text-sm font-medium transition-all duration-200 {% if url_name == 'statistics' %}bg-muted text-foreground{% else %}text-muted-foreground hover:bg-muted hover:text-foreground{% endif %}">
              <i class="fas fa-shopping-cart w-5 text-center"></i>
              <span class="sidebar-label ml-3">Statistika</span>
              <span class="tooltip">Statistika</span>
            </a>
            {% endwith %}
          </nav>
        </aside>
      </div>
      {% endif %}

      <!-- Updated main content wrapper -->
      <div class="main-content-wrapper">
        <main class="main-content">
          <div class="page-content h-full overflow-y-auto p-6 sm:p-8 bg-muted/30">
            <div class="mx-auto">
              {% block content %}
              <div class="mb-8">
                <h1 class="font-sans text-3xl font-bold tracking-tight text-foreground">Xush kelibsiz, {{
                  user.first_name }}</h1>
                <p class="text-muted-foreground mt-2">Platformamizning asosiy sahifasi</p>
              </div>

              <div class="bg-background border border-border rounded-xl p-8 shadow-sm">
                <p class="text-muted-foreground">Bu yerda dashboardning asosiy ma'lumotlari bo'ladi. Minimalistik va
                  toza dizayn.</p>
              </div>
              {% endblock %}
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const themeToggle = document.getElementById("themeToggle");
      const docElement = document.documentElement;
      const loadingOverlay = document.getElementById("loadingOverlay");

      const applyTheme = (theme) => {
        if (theme === 'dark') {
          docElement.classList.add('dark');
          docElement.style.colorScheme = 'dark';
        } else {
          docElement.classList.remove('dark');
          docElement.style.colorScheme = 'light';
        }
      };

      const savedTheme = localStorage.getItem('theme');
      const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const initialTheme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
      applyTheme(initialTheme);

      if (themeToggle) {
        themeToggle.onclick = () => {
          const isDarkMode = docElement.classList.contains("dark");
          const newTheme = isDarkMode ? 'light' : 'dark';
          localStorage.setItem("theme", newTheme);
          applyTheme(newTheme);
        };
      }

      const showLoader = () => {
        if (loadingOverlay) {
          loadingOverlay.classList.add('show');
        }
      };

      const hideLoader = () => {
        if (loadingOverlay) {
          loadingOverlay.classList.remove('show');
        }
      };

      let loadingTimeout;
      document.querySelectorAll('a[href]').forEach(link => {
        if (link.href && !link.href.includes('#') && !link.href.includes('javascript:') && !link.href.includes('mailto:')) {
          link.addEventListener('click', (e) => {
            if (!e.ctrlKey && !e.metaKey && !e.shiftKey) {
              clearTimeout(loadingTimeout);
              loadingTimeout = setTimeout(showLoader, 100); // Slight delay to prevent flashing

              // Auto-hide loader after reasonable time
              setTimeout(() => {
                hideLoader();
              }, 3000);
            }
          });
        }
      });

      window.addEventListener('load', () => {
        clearTimeout(loadingTimeout);
        hideLoader();
      });

      document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
          clearTimeout(loadingTimeout);
          hideLoader();
        }
      });

      window.addEventListener('beforeunload', () => {
        clearTimeout(loadingTimeout);
        hideLoader();
      });

      // Foydalanuvchi menyusi (User Menu)
      const userBtn = document.getElementById("userBtn");
      const userMenu = document.getElementById("userMenu");

      if (userBtn && userMenu) {
        userBtn.addEventListener("click", (event) => {
          event.stopPropagation();
          userMenu.classList.toggle("hidden");
        });

        document.addEventListener("click", (e) => {
          if (!userMenu.classList.contains("hidden") && !userMenu.contains(e.target) && !userBtn.contains(e.target)) {
            userMenu.classList.add("hidden");
          }
        });
      }

      const sidebar = document.getElementById("sidebar");
      const sidebarWrapper = document.getElementById("sidebarWrapper");
      const sidebarToggle = document.getElementById("sidebarToggle");
      const sidebarOverlay = document.getElementById("sidebarOverlay");

      let isExamMode = false;
      let examTimer = null;
      let examTimeLeft = 0;
      let examStartTime = null;
      let examDuration = 0;

      const isExamPage = window.location.pathname.includes('/take/');

      if (isExamPage) {
        document.body.classList.add('exam-mode');
        isExamMode = true;

        // Force sidebar to be hidden on exam pages
        if (sidebar && sidebarWrapper) {
          setSidebarState(true, true); // Force hide, don't save to localStorage
        }

        // Initialize exam timer
        initializeExamTimer();

        // Add beforeunload warning
        window.addEventListener('beforeunload', handleExamPageLeave);

        // Add navigation warning for exam pages
        document.addEventListener('click', handleExamNavigation);
      }

      function initializeExamTimer() {
        const examTimerElement = document.getElementById('examTimer');
        const examTimeLeftElement = document.getElementById('examTimeLeft');

        if (examTimerElement && examTimeLeftElement) {
          examTimerElement.classList.remove('hidden');

          // Get exam duration from page (this should be set by Django template)
          const examData = getExamDataFromPage();
          if (examData) {
            examDuration = examData.duration * 60; // Convert to seconds
            examStartTime = examData.startTime || Date.now();

            // Calculate remaining time
            const elapsed = Math.floor((Date.now() - examStartTime) / 1000);
            examTimeLeft = Math.max(0, examDuration - elapsed);

            // Start timer
            startExamTimer();
          }
        }
      }

      function getExamDataFromPage() {
        // This function should extract exam data from the page
        // For now, we'll use a simple approach
        const timerElement = document.querySelector('#time-left');
        if (timerElement) {
          const timeText = timerElement.textContent;
          const [minutes, seconds] = timeText.split(':').map(Number);
          return {
            duration: minutes + (seconds / 60),
            startTime: localStorage.getItem('examStartTime') ? parseInt(localStorage.getItem('examStartTime')) : Date.now()
          };
        }
        return null;
      }

      function startExamTimer() {
        if (examTimer) clearInterval(examTimer);

        examTimer = setInterval(() => {
          if (examTimeLeft <= 0) {
            clearInterval(examTimer);
            // Auto-submit exam
            const examForm = document.getElementById('examForm');
            if (examForm) {
              examForm.submit();
            }
            return;
          }

          examTimeLeft--;
          updateExamTimerDisplay();

          // Save progress to localStorage
          localStorage.setItem('examTimeLeft', examTimeLeft);
          localStorage.setItem('examStartTime', examStartTime);

        }, 1000);
      }

      function updateExamTimerDisplay() {
        const examTimeLeftElement = document.getElementById('examTimeLeft');
        if (examTimeLeftElement) {
          const minutes = Math.floor(examTimeLeft / 60);
          const seconds = examTimeLeft % 60;
          examTimeLeftElement.textContent =
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
      }

      function handleExamPageLeave(e) {
        if (isExamMode) {
          e.preventDefault();
          e.returnValue = 'Testni yakunlaysizmi? Barcha javoblaringiz saqlanadi.';
          return e.returnValue;
        }
      }

      function handleExamNavigation(e) {
        const target = e.target.closest('a');
        if (target && target.href && !target.href.includes('#') && isExamMode) {
          e.preventDefault();
          showExamWarning(() => {
            // Submit exam and navigate
            const examForm = document.getElementById('examForm');
            if (examForm) {
              examForm.submit();
            } else {
              window.location.href = target.href;
            }
          });
        }
      }

      function showExamWarning(onConfirm) {
        const modal = document.getElementById('examWarningModal');
        const cancelBtn = document.getElementById('examWarningCancel');
        const confirmBtn = document.getElementById('examWarningConfirm');

        if (modal) {
          modal.classList.add('show');

          cancelBtn.onclick = () => {
            modal.classList.remove('show');
          };

          confirmBtn.onclick = () => {
            modal.classList.remove('show');
            onConfirm();
          };
        }
      }

      const setSidebarState = (isHidden, forceNoSave = false) => {
        // Don't save sidebar state in exam mode
        if (!isExamMode && !forceNoSave) {
          localStorage.setItem("sidebarHidden", isHidden);
        }

        if (sidebar && sidebarWrapper) {
          sidebar.dataset.collapsed = isHidden;
          const isMobile = window.innerWidth < 768;

          if (isHidden) {
            sidebar.classList.add("sidebar-hidden");
            sidebarWrapper.classList.add("hidden");
            if (sidebarOverlay) {
              sidebarOverlay.classList.remove("show");
            }
          } else {
            sidebar.classList.remove("sidebar-hidden");
            sidebarWrapper.classList.remove("hidden");
            if (isMobile && sidebarOverlay) {
              sidebarOverlay.classList.add("show");
            }
          }
        }
      };

      const handleMobileNavigation = () => {
        const isMobile = window.innerWidth < 768;
        if (isMobile && !sidebar.classList.contains("sidebar-hidden")) {
          setSidebarState(true);
        }
      };

      if (sidebar && sidebarToggle && sidebarWrapper) {
        sidebarToggle.addEventListener("click", () => {
          const isCurrentlyHidden = sidebar.classList.contains("sidebar-hidden");
          setSidebarState(!isCurrentlyHidden);
        });

        if (sidebarOverlay) {
          sidebarOverlay.addEventListener("click", () => {
            setSidebarState(true);
          });
        }

        const sidebarLinks = sidebar.querySelectorAll('a[href]');
        sidebarLinks.forEach(link => {
          link.addEventListener('click', () => {
            // Auto-close sidebar on mobile after clicking a link
            setTimeout(handleMobileNavigation, 100);
          });
        });

        if (!isExamMode) {
          const isMobile = window.innerWidth < 768;
          const savedSidebarState = localStorage.getItem("sidebarHidden");
          let initialSidebarState;

          if (savedSidebarState !== null) {
            initialSidebarState = savedSidebarState === "true";
          } else {
            initialSidebarState = isMobile; // Hide by default on mobile
          }

          setSidebarState(initialSidebarState);
        }

        let resizeTimeout;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimeout);
          resizeTimeout = setTimeout(() => {
            const isMobileNow = window.innerWidth < 768;
            const isCurrentlyHidden = sidebar.classList.contains("sidebar-hidden");

            if (isMobileNow && !isCurrentlyHidden) {
              // On mobile, ensure overlay is shown when sidebar is open
              if (sidebarOverlay) {
                sidebarOverlay.classList.add("show");
              }
            } else if (!isMobileNow) {
              // On desktop, hide overlay
              if (sidebarOverlay) {
                sidebarOverlay.classList.remove("show");
              }
            }
          }, 100);
        });
      }
    });
  </script>
</body>
</html>